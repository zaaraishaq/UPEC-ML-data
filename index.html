<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPEC Genomic Database</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .scientific-table th { position: sticky; top: 0; background-color: #f3f4f6; z-index: 10; }
        .gradient-bg { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex flex-col min-h-screen">

    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <i class="fa-solid fa-dna text-2xl mr-3"></i>
                    <span class="font-bold text-xl tracking-tight">UPEC<span class="font-light opacity-80">GenoDB</span></span>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="#" onclick="switchTab('dashboard')" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-white/10 transition">Dashboard</a>
                        <a href="#" onclick="switchTab('browser')" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-white/10 transition">Genome Browser</a>
                        <a href="https://github.com/zaaraishaq/UPEC-ML-data" target="_blank" class="px-3 py-2 rounded-md text-sm font-medium bg-white/20 hover:bg-white/30 transition"><i class="fab fa-github mr-2"></i>GitHub Repo</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
        
        <!-- DASHBOARD VIEW -->
        <div id="dashboard-view" class="space-y-6 animate-fade-in">
            <!-- Header Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-600">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100 text-blue-600"><i class="fa-solid fa-bacteria"></i></div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Total Isolates</p>
                            <p class="text-2xl font-bold text-gray-900" id="stat-total">Loading...</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-emerald-500">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-emerald-100 text-emerald-600"><i class="fa-solid fa-microscope"></i></div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Genomic Features</p>
                            <p class="text-2xl font-bold text-gray-900">73,218</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-purple-500">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-purple-100 text-purple-600"><i class="fa-solid fa-barcode"></i></div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Unique STs</p>
                            <p class="text-2xl font-bold text-gray-900" id="stat-st">Loading...</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-orange-500">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-orange-100 text-orange-600"><i class="fa-solid fa-layer-group"></i></div>
                        <div class="ml-4">
                            <p class="text-sm font-medium text-gray-500">Pangenome Clusters</p>
                            <p class="text-2xl font-bold text-gray-900">72,590</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Description -->
            <div class="bg-white rounded-xl shadow-sm p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Study Overview</h2>
                <p class="text-gray-600 leading-relaxed mb-4">
                    This database contains genomic profiles of <strong>1,184 publicly available UPEC genomes</strong> derived from human-specific isolates associated with urinary tract pathology. 
                    The dataset integrates MLST, Serotyping, ARG prediction, Point Mutations, Virulence Factors, and Pangenome analysis into a comprehensive analytical matrix.
                </p>
                <div class="flex flex-wrap gap-2">
                    <span class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-semibold">Prokka</span>
                    <span class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-semibold">Roary</span>
                    <span class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-semibold">ResFinder</span>
                    <span class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-semibold">PlasmidFinder</span>
                    <span class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-semibold">VFDB</span>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Sequence Types (Top 5)</h3>
                    <div class="h-64">
                        <canvas id="stChart"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Pangenome Structure</h3>
                    <div class="h-64">
                        <canvas id="pangenomeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- BROWSER VIEW -->
        <div id="browser-view" class="hidden space-y-6">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 space-y-4 md:space-y-0">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900">Genome Browser</h2>
                        <p class="text-sm text-gray-500">Search and filter metadata. Download full matrix below.</p>
                    </div>
                    
                    <!-- Download Section -->
                    <div class="flex space-x-3">
                        <a href="UPEC_Metadata_Complete.csv" download class="flex items-center px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition shadow-sm">
                            <i class="fa-solid fa-file-csv mr-2"></i> Download Metadata
                        </a>
                        <a href="final_cleaned_no_dot_suffix_duplicates.zip" class="flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-sm">
                            <i class="fa-solid fa-database mr-2"></i> Full Binary Matrix (.zip)
                        </a>
                        <a href="All_Genomes.zip" class="flex items-center px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition shadow-sm">
                            <i class="fa-solid fa-dna mr-2"></i> All Fastas (.zip)
                        </a>
                    </div>
                </div>

                <!-- Search & Filters -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="relative col-span-2">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i class="fa-solid fa-search text-gray-400"></i>
                        </div>
                        <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Search by Accession, ST, or Serotype..." class="pl-10 block w-full rounded-lg border-gray-300 bg-gray-50 border focus:ring-blue-500 focus:border-blue-500 py-2">
                    </div>
                    <select id="pathologyFilter" onchange="filterTable()" class="block w-full rounded-lg border-gray-300 bg-gray-50 border px-3 py-2">
                        <option value="">All Pathologies</option>
                        <!-- Options populated by JS -->
                    </select>
                    <select id="stFilter" onchange="filterTable()" class="block w-full rounded-lg border-gray-300 bg-gray-50 border px-3 py-2">
                        <option value="">All Sequence Types</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>

                <!-- Data Table -->
                <div class="overflow-x-auto rounded-lg border border-gray-200" style="max-height: 600px;">
                    <table class="min-w-full divide-y divide-gray-200 scientific-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Accession ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">ST</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Serotype</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Pathology</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Year</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Location</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Rows will be populated by JS -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 flex justify-between items-center text-sm text-gray-500">
                    <span id="showingCount">Showing 0 of 0 entries</span>
                    <div class="flex space-x-2">
                        <button onclick="prevPage()" class="px-3 py-1 border rounded hover:bg-gray-50">Previous</button>
                        <button onclick="nextPage()" class="px-3 py-1 border rounded hover:bg-gray-50">Next</button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="bg-white border-t mt-12 py-8">
        <div class="max-w-7xl mx-auto px-4 text-center text-gray-500 text-sm">
            <p>&copy; 2024 UPEC Genomic Study.</p>
            <p>Data retrieved from NCBI (July 25, 2024).</p>
        </div>
    </footer>

    <!-- Details Modal -->
    <div id="detailsModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 p-6 animate-fade-in">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-xl font-bold text-gray-900" id="modalTitle">Isolate Details</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div id="modalContent" class="space-y-4">
                <!-- Content injected via JS -->
            </div>
        </div>
    </div>

    <!-- IMPORTANT: Load the data generated by the Python script -->
    <script src="data.js"></script>

    <script>
        // Check if data loaded correctly
        if (typeof window.dbData === 'undefined') {
            console.warn("data.js not found. Using fallback placeholder data.");
            window.dbData = [];
        }

        // --- APP LOGIC ---

        let currentPage = 1;
        const rowsPerPage = 15;
        let filteredData = [];

        function init() {
            // Sort data by ID
            filteredData = [...window.dbData].sort((a, b) => a.id.localeCompare(b.id));
            
            populateFilters();
            renderTable();
            initCharts();
            
            // Update Dashboard Stats
            document.getElementById('stat-total').innerText = window.dbData.length.toLocaleString();
            const uniqueSTs = new Set(window.dbData.map(d => d.st)).size;
            document.getElementById('stat-st').innerText = uniqueSTs.toLocaleString();
        }

        function switchTab(tabName) {
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('browser-view').classList.add('hidden');
            
            if(tabName === 'dashboard') {
                document.getElementById('dashboard-view').classList.remove('hidden');
            } else {
                document.getElementById('browser-view').classList.remove('hidden');
            }
        }

        function populateFilters() {
            const pathologies = [...new Set(window.dbData.map(d => d.pathology).filter(Boolean))].sort();
            const sts = [...new Set(window.dbData.map(d => d.st).filter(Boolean))].sort();

            const pathSelect = document.getElementById('pathologyFilter');
            pathologies.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.innerText = p;
                pathSelect.appendChild(opt);
            });

            const stSelect = document.getElementById('stFilter');
            sts.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.innerText = s;
                stSelect.appendChild(opt);
            });
        }

        function filterTable() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const pathology = document.getElementById('pathologyFilter').value;
            const st = document.getElementById('stFilter').value;

            filteredData = window.dbData.filter(item => {
                const s = search;
                const matchSearch = (item.id || "").toLowerCase().includes(s) || 
                                    (item.st || "").toLowerCase().includes(s) || 
                                    (item.serotype || "").toLowerCase().includes(s);
                const matchPath = pathology === "" || item.pathology === pathology;
                const matchST = st === "" || item.st === st;
                return matchSearch && matchPath && matchST;
            });

            currentPage = 1;
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = filteredData.slice(start, end);

            pageData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-blue-50 transition";
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600 font-mono">${row.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700"><span class="px-2 py-1 bg-gray-100 rounded text-xs font-bold">${row.st || 'N/A'}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 font-mono">${row.serotype || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${row.pathology || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${row.year || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${row.location || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <button onclick="viewDetails('${row.id}')" class="text-blue-600 hover:text-blue-900"><i class="fa-solid fa-eye"></i> View</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('showingCount').innerText = `Showing ${start + 1} to ${Math.min(end, filteredData.length)} of ${filteredData.length} entries`;
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }

        function nextPage() {
            if ((currentPage * rowsPerPage) < filteredData.length) {
                currentPage++;
                renderTable();
            }
        }

        function viewDetails(id) {
            const item = window.dbData.find(d => d.id === id);
            if(!item) return;

            document.getElementById('modalTitle').innerText = `Isolate: ${item.id}`;
            document.getElementById('modalContent').innerHTML = `
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div><span class="font-bold text-gray-700">Sequence Type:</span> ${item.st || 'N/A'}</div>
                    <div><span class="font-bold text-gray-700">Serotype:</span> ${item.serotype || 'N/A'}</div>
                    <div><span class="font-bold text-gray-700">Host Disease:</span> ${item.pathology || 'N/A'}</div>
                    <div><span class="font-bold text-gray-700">Year:</span> ${item.year || 'N/A'}</div>
                    <div><span class="font-bold text-gray-700">Location:</span> ${item.location || 'N/A'}</div>
                    <div><span class="font-bold text-gray-700">Source:</span> ${item.source || 'N/A'}</div>
                </div>
                <hr class="border-gray-200">
                <div>
                    <h4 class="font-bold text-gray-800 mb-2">Accession Links</h4>
                    <div class="flex flex-wrap gap-2 text-sm">
                        ${item.bioproject ? `<a href="https://www.ncbi.nlm.nih.gov/bioproject/${item.bioproject}" target="_blank" class="text-blue-600 underline">BioProject: ${item.bioproject}</a>` : ''}
                        ${item.biosample ? `<span class="text-gray-600">BioSample: ${item.biosample}</span>` : ''}
                    </div>
                </div>
                <div class="mt-4 p-3 bg-yellow-50 rounded text-xs text-yellow-700">
                    <i class="fa-solid fa-triangle-exclamation mr-1"></i> 
                    Detailed binary feature data (ARGs, Virulence Factors, etc.) is available in the "Full Binary Matrix" download.
                </div>
            `;
            document.getElementById('detailsModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('detailsModal').classList.add('hidden');
        }

        // --- CHARTS ---
        function initCharts() {
            if (!window.dbData || window.dbData.length === 0) return;

            // ST Distribution Chart
            const stCounts = {};
            window.dbData.forEach(d => {
                const s = d.st || 'Unknown';
                stCounts[s] = (stCounts[s] || 0) + 1;
            });
            
            // Get top 5
            const sortedST = Object.entries(stCounts).sort((a,b) => b[1] - a[1]).slice(0, 5);
            
            const ctxST = document.getElementById('stChart').getContext('2d');
            new Chart(ctxST, {
                type: 'doughnut',
                data: {
                    labels: sortedST.map(x => x[0]),
                    datasets: [{
                        data: sortedST.map(x => x[1]),
                        backgroundColor: ['#3b82f6', '#10b981', '#8b5cf6', '#f59e0b', '#ef4444', '#cbd5e1']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });

            // Pangenome Chart (Static based on manuscript data)
            const ctxPan = document.getElementById('pangenomeChart').getContext('2d');
            new Chart(ctxPan, {
                type: 'bar',
                data: {
                    labels: ['Core', 'Soft Core', 'Shell', 'Cloud'],
                    datasets: [{
                        label: 'Gene Count',
                        data: [1473, 660, 4488, 65969],
                        backgroundColor: ['#1e40af', '#3b82f6', '#93c5fd', '#dbeafe']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { type: 'logarithmic' } } }
            });
        }

        // Wait for data.js to potentially load
        window.onload = function() {
            // Short timeout to ensure variable is populated if script loads async
            setTimeout(init, 100);
        };
    </script>
</body>
</html>